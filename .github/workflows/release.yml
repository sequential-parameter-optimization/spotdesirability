name: Release

on:
  push:
    branches:
      - main
      - develop

# Principle of Least Privilege: Base permissions are read-only
permissions: read-all

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      id-token: write
    if: "!contains(github.event.head_commit.message, 'chore(release)')"

    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@d4b2f3b6ecc6e67c4457f6d3e41ec42d3d0fcb86  # v5.4.2

      - name: Install dependencies
        run: |
          uv pip install --system build
          uv pip install --system -e ".[dev]"

      - name: Run tests
        run: |
          uv run pytest tests/ -v

      - name: Verify package name in pyproject.toml
        run: |
          grep -q "name = \"spotdesirability\"" pyproject.toml || (echo "ERROR: Package name mismatch in pyproject.toml" && exit 1)
          echo "✓ Package name verified: spotdesirability"

      - name: Build distribution packages
        run: |
          rm -rf dist/ build/
          uv build
          echo "Build artifacts created:"
          ls -lah dist/

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: 20

      - name: Semantic Release
        uses: cycjimmy/semantic-release-action@b12c8f6015dc215fe37bc154d4ad456dd3833c90 # v6.0.0
        with:
          extra_plugins: |
            @semantic-release/git@10
            @semantic-release/changelog@6
            @semantic-release/exec@6
            conventional-changelog-conventionalcommits@7
        env:
          GITHUB_TOKEN: ${{ secrets.SEMANTIC_RELEASE_TOKEN }}

      - name: Publish to PyPI
        if: success()
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e  # release/v1
        with:
          packages-dir: dist/
          skip-existing: true
          # Note: No token needed with Trusted Publishers (OIDC)

      - name: Install Quarto CLI
        if: success()
        uses: quarto-dev/quarto-actions/setup@8a96df13519ee81fd526f2dfca5962811136661b  # v2.2.0
        with:
          version: "1.7.29"

      - name: Generate API reference stubs
        if: success()
        run: |
          uv run python docs/quartodoc_build.py
          uv run quartodoc interlinks

      - name: Build documentation
        if: success()
        run: |
          uv run quarto render --no-cache

      - name: Setup Git Credentials for Publish
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git

      - name: Deploy documentation
        if: success()
        uses: quarto-dev/quarto-actions/publish@8a96df13519ee81fd526f2dfca5962811136661b  # v2.2.0
        with:
          target: gh-pages
          path: _site
          render: "false"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verify PyPI Release
        if: success()
        run: |
          echo "Release completed successfully!"
          echo "Verifying package on PyPI..."
          for i in {1..30}; do
            if python -c "import urllib.request; urllib.request.urlopen('https://pypi.org/project/spotdesirability/')" 2>/dev/null; then
              echo "✓ Package found on PyPI"
              break
            fi
            if [ $i -lt 30 ]; then
              echo "Waiting for PyPI to sync (attempt $i/30)..."
              sleep 10
            fi
          done
